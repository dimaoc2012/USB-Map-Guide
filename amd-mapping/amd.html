
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>AMD and 3rd Party USB Mapping Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-anchors/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-medium-zoom/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
        <link rel="stylesheet" href="../styles/website.css">
        
    

    

        
    
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../misc/" />
    
    
    <link rel="prev" href="../intel-mapping/intel.html" />
    

    <style>
    @media only screen and (max-width: 640px) {
        .book-header .hidden-mobile {
            display: none;
        }
    }
    </style>
    <script>
        window["gitbook-plugin-github-buttons"] = {"buttons":[{"user":"dortania","repo":"USB-Map-Guide","type":"star","size":"large"}]};
    </script>

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    USB Mapping
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../system-preparation.html">
            
                <a href="../system-preparation.html">
            
                    
                    System Preparation
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Intel Mapping</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="../intel-mapping/intel.html">
            
                <a href="../intel-mapping/intel.html">
            
                    
                    Intel USB Mapping
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">AMD/3rd Party Mapping</li>
        
        
    
        <li class="chapter active" data-level="3.1" data-path="amd.html">
            
                <a href="amd.html">
            
                    
                    AMD and 3rd Party USB Mapping
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Miscellaneous Fixes</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="../misc/">
            
                <a href="../misc/">
            
                    
                    Miscellaneous Fixes
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.1" data-path="../misc/power.html">
            
                <a href="../misc/power.html">
            
                    
                    Fixing USB Power
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2" data-path="../misc/shutdown.html">
            
                <a href="../misc/shutdown.html">
            
                    
                    Fixing Shutdown/Restart
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3" data-path="../misc/instant-wake.html">
            
                <a href="../misc/instant-wake.html">
            
                    
                    GPRW/UPRW/LANC Instant Wake Patch
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4" data-path="../misc/keyboard.html">
            
                <a href="../misc/keyboard.html">
            
                    
                    Keyboard Wake Issues
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >AMD and 3rd Party USB Mapping</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <blockquote>
<p><em>Last modified: Sat Jun 20 2020 16:54:40 GMT+0000 (Coordinated Universal Time)</em></p>
</blockquote>
<h1 id="usb-mapping"><a name="usb-mapping" class="plugin-anchor" href="#usb-mapping"><i class="fa fa-link" aria-hidden="true"></i></a>USB Mapping</h1>
<p>Table of Contents:</p>
<ul>
<li><a href="amd.html#amd-and-3rd-party-usb-mapping">AMD and 3rd Party USB Mapping</a></li>
<li><a href="amd.html#creating-the-map">Creating the map</a></li>
<li><a href="amd.html#port-mapping-on-screwed-up-dsdts">Port mapping on screwed up DSDTs</a></li>
<li><a href="amd.html#port-mapping-when-you-have-multiple-of-the-same-controller">Port mapping when you have multiple of the same controller</a></li>
</ul>
<p>So with the prerequisites out of the way, we can finally get to the meat of this guide. And now we get to finally read one of my favorite books before I go to bed each night: <a href="https://uefi.org/sites/default/files/resources/ACPI_6_3_final_Jan30.pdf" target="_blank">The Advanced Configuration and Power Interface (ACPI) Specification!</a></p>
<p>Now if you haven&apos;t read through this before(which I highly recommend you do, it&apos;s a thrilling tale), I&apos;ll point you to the meat of the USB situation:</p>
<ul>
<li>Section 9.14: _UPC (USB Port Capabilities)</li>
</ul>
<p>Here we&apos;re greeted with all the possible USB ports in ACPI:</p>
<table>
<thead>
<tr>
<th style="text-align:left">Type</th>
<th style="text-align:left">Info</th>
<th style="text-align:left">Comments</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">0</td>
<td style="text-align:left">USB 2.0 Type-A connector</td>
<td style="text-align:left">This is what macOS will default all ports to when no map is present</td>
</tr>
<tr>
<td style="text-align:left">3</td>
<td style="text-align:left">USB 3.0 Type-A connector</td>
<td style="text-align:left">3.0, 3.1 and 3.2 ports share the same Type</td>
</tr>
<tr>
<td style="text-align:left">8</td>
<td style="text-align:left">Type C connector - USB 2.0-only</td>
<td style="text-align:left">Mainly seen in phones</td>
</tr>
<tr>
<td style="text-align:left">9</td>
<td style="text-align:left">Type C connector - USB 2.0 and USB 3.0 with Switch</td>
<td style="text-align:left">Flipping the device <strong>does not</strong> change the ACPI port</td>
</tr>
<tr>
<td style="text-align:left">10</td>
<td style="text-align:left">Type C connector - USB 2.0 and USB 3.0 without Switch</td>
<td style="text-align:left">Flipping the device <strong>does</strong> change the ACPI port. generally seen on 3.1/2 motherboard headers</td>
</tr>
<tr>
<td style="text-align:left">255</td>
<td style="text-align:left">Proprietary connector</td>
<td style="text-align:left">For Internal USB ports like Bluetooth</td>
</tr>
</tbody>
</table>
<h2 id="amd-and-3rd-party-usb-mapping"><a name="amd-and-3rd-party-usb-mapping" class="plugin-anchor" href="#amd-and-3rd-party-usb-mapping"><i class="fa fa-link" aria-hidden="true"></i></a>AMD and 3rd Party USB Mapping</h2>
<p>The steps are quite simple:</p>
<ul>
<li>Read this guide</li>
<li>Cry a bit</li>
<li>Cry some more</li>
<li>Buy some Intel hardware</li>
<li>Return said hardware</li>
<li>Gather courage to USB map on AMD</li>
<li>Read the rest of the guide <em>again</em> and actually USB map</li>
</ul>
<h2 id="creating-the-map"><a name="creating-the-map" class="plugin-anchor" href="#creating-the-map"><i class="fa fa-link" aria-hidden="true"></i></a>Creating the map</h2>
<p>So to start off, open <a href="https://github.com/toleda/audio_ALCInjection/blob/master/IORegistryExplorer_v2.1.zip" target="_blank">IORegistryExplorer</a> and find the USB controller you&apos;d wish to map. For controllers, they come in some variations:</p>
<ul>
<li>XHC</li>
<li>XHC0</li>
<li>XHC1</li>
<li>XHC2</li>
<li>XHCI</li>
<li>XHCX</li>
<li>AS43</li>
<li>PTXH (Commonly associated with AMD Chipset controllers)</li>
<li>PXSX(This is a generic PCIe device, <strong>double check it&apos;s a USB device</strong>)</li>
</ul>
<p>The best way to find controllers is by searching for <code>XHC</code> and then looking at the results that come up, the parent of all the ports is the USB controller. Do note that many boards have multiple controllers but the port limit is per controller.</p>
<p>For today&apos;s example, we&apos;ll be both adding missing ports and getting under the 15 port limit for this X399 chipset which has the identifier <code>PTXH</code></p>
<p><img src="../images/amd-mapping/amd-md/controller-name.png" alt="PTXH IOReg"></p>
<p>As you can see from the photo above, we&apos;re missing a shit ton of ports! Specifically ports POT3, POT4, POT7, POT8, PO12, PO13, PO15, PO16, PO17, PO18, PO19, PO20, PO21, PO22!</p>
<p>So how do we fix this? Well if you look in the corner you&apos;ll see the <code>port</code> value. This is going to be important to us when mapping</p>
<p>Next, let&apos;s take a peek at our DSDT and check for our <code>PTXH</code> device with <a href="https://github.com/acidanthera/MaciASL/releases" target="_blank">maciASL</a>:</p>
<table>
<thead>
<tr>
<th style="text-align:center">Top of PTXH</th>
<th style="text-align:center">Bottom of PTXH</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><img src="../images/amd-mapping/amd-md/dsdt-1.png" alt=""></td>
<td style="text-align:center"><img src="../images/amd-mapping/amd-md/dsdt-2.png" alt=""></td>
</tr>
</tbody>
</table>
<p>All of our ports are here! So why in the world is macOS hiding them? Well there&apos;s a couple of reasons but this being the main: Conflicting SMBIOS USB map</p>
<p>Inside the <code>AppleUSBHostPlatformProperties.kext</code> you&apos;ll find the USB map for most SMBIOS, this means that that machine&apos;s USB map is forced onto your system.</p>
<p>Well to kick out these bad maps, we gotta make a plugin kext. For us, that&apos;s the <a href="https://github.com/dortania/USB-Map-Guide/tree/master/extra-files/AMD-USB-Map.kext.zip" target="_blank">AMD-USB-Map.kext</a></p>
<p>Now right-click and press <code>Show Package Contents</code>, then navigate to <code>Contents/Info.plist</code></p>
<p><img src="../images/amd-mapping/amd-md/usb-plist.png" alt="">
If the port values don&apos;t show in Xcode, right click and select <code>Show Raw Keys/Values</code>
<img src="../images/amd-mapping/amd-md/usb-plist-info.png" alt=""></p>
<p>So what kind of data do we shove into this plist? Well, there are a couple of sections to note:</p>
<ul>
<li><strong>Model</strong>: SMBIOS the kext will match against, set this up to what SMBIOS you are currently using</li>
<li><strong>IONameMatch</strong>: The name of the controller it&apos;ll match against, in this example we&apos;ll use <code>PTXH</code></li>
<li><strong>port-count</strong>: The last/largest port value that you want to be injected</li>
<li><strong>port</strong>: The address of the USB controller</li>
<li><strong>UsbConnector</strong>: The type of USB connector, which can be found on the <a href="https://uefi.org/sites/default/files/resources/ACPI_6_3_final_Jan30.pdf" target="_blank">ACPI 6.3 spec, section 9.14</a></li>
</ul>
<blockquote>
<p>How do I know which ports are 2.0 and which are 3.0?</p>
</blockquote>
<p>Well, the easiest way is grabbing a USB 2.0 and USB 3.0 device, then write down which ports are are what type from observing IOReg.</p>
<p>Now, let&apos;s take this section:</p>
<pre><code>Device (PO18)
   {
   Name (_ADR, 0x12) // _ADR: Address
   Name (_UPC, Package (0x04) // _UPC: USB Port Capabilities
      {
         Zero,
         0xFF,
         Zero,
         Zero
      })
   }
</code></pre><p>For us, what matters is the <code>Name (_ADR, 0x12) // _ADR: Address</code> as this tells us the location of the USB port. This value will be turned into our <code>port</code> value on the plist. Some DSDTs don&apos;t declare their USB address, for these situations we can see their IOReg properties.</p>
<p><img src="../images/amd-mapping/amd-md/port-info.png" alt=""></p>
<p><strong>Reminder</strong>: Don&apos;t drag and drop the kext, read the guide carefully. Rename <code>IONameMatch</code> value to the correct controller you&apos;re wanting to map and verify that the ports are named correctly to <strong>your DSDT</strong>. If you could drag and drop it and have it work for everyone there wouldn&apos;t be a guide ;p</p>
<p>Now save and add this to both your kext folder and config.plist then reboot!</p>
<p>Now we can finally start to slowly remove unwanted ports from the Info.plist and remove the <code>XhciPortLimit</code> quirk once you have 15 ports total or less per controller.</p>
<h2 id="port-mapping-on-screwed-up-dsdts"><a name="port-mapping-on-screwed-up-dsdts" class="plugin-anchor" href="#port-mapping-on-screwed-up-dsdts"><i class="fa fa-link" aria-hidden="true"></i></a>Port mapping on screwed up DSDTs</h2>
<p>Something you may have noticed is that your DSDT is even missing some ports, like for example:</p>
<p><img src="../images/amd-mapping/amd-md/dsdt-missing.png" alt="AsRock B450 missing ports"></p>
<p>In this DSDT, we&apos;re missing HS02, HS03, HS04, HS05, etc. When this happens, we actually need to outright remove all our ports from that controller in our DSDT. What this will let us do is allow macOS to build the ports itself instead of basing it off of the ACPI. Save this modified DSDT.aml and place it in your EFI/OC/ACPI folder and specify it in your config.plist -&gt; ACPI -&gt; Add(note that DSDT.aml must be forced to work correctly)</p>
<h2 id="port-mapping-when-you-have-multiple-of-the-same-controller"><a name="port-mapping-when-you-have-multiple-of-the-same-controller" class="plugin-anchor" href="#port-mapping-when-you-have-multiple-of-the-same-controller"><i class="fa fa-link" aria-hidden="true"></i></a>Port mapping when you have multiple of the same controller</h2>
<p>This becomes a problem when we run systems with many USB controllers which all want to have the same identifier, commonly being multiple XHC0 devices or AsMedia controllers showing up as generic PXSX devices. To fix this, we have 2 options:</p>
<ul>
<li>ACPI Rename (won&apos;t be covered in this guide, see ACPI section of OpenCore&apos;s configuration.pdf)</li>
<li>SSDT Recreation</li>
</ul>
<h3 id="ssdt-recreation"><a name="ssdt-recreation" class="plugin-anchor" href="#ssdt-recreation"><i class="fa fa-link" aria-hidden="true"></i></a>SSDT Recreation</h3>
<p>With the SSDT Recreation method, what we&apos;ll be doing is &quot;renaming&quot; the device but in reality creating a brand new device just for macOS that is in the exact same spot as your old USB controller.</p>
<p>To do this, grab the following SSDT:</p>
<ul>
<li><a href="https://github.com/dortania/USB-Map-Guide/tree/master/extra-files/SSDT-SHC0.dsl" target="_blank">SSDT-SHC0.dsl</a></li>
</ul>
<p>What you&apos;ll want to do is find a controller you want to rename, find its full ACPI path and replace the one in the sample SSDT. In our sample, we&apos;re be renaming <code>PCI0.GP13.XHC0</code> to <code>SHC0</code> so change accordingly.</p>
<p><img src="../images/amd-mapping/amd-md/rename-ssdt.png" alt="AsRock B450 missing ports"></p>
<p><strong>Note</strong>: In rare cases, macOS isn&apos;t able to properly rebuild the USB ports with the new &quot;fake&quot; USB controller. In these situations we need to manually add ports to it that are present in the original controller(ie. HS01, HS02, POT1, etc)</p>
<blockquote>
<p>But how do I map a non-standard controller that shows up as PXSX?</p>
</blockquote>
<p>Similar idea to regular SSDT renaming except you need to actually find the controller. This becomes difficult as SSDs, network controllers, and other generic PCIe devices can also show up as PXSX. Check the ACPI-path in IOreg to find its path:</p>
<p><img src="../images/amd-mapping/amd-md/acpi-path.png" alt=""></p>
<p>As we can see, <code>IOACPIPlane:/_SB/PC00@0/RP05@1c0004/PXSX@0</code> would be interpreted as <code>SB.PC00.RP05.PXSX</code></p>
<p>And so from the above SSDT, we change the following:</p>
<ul>
<li><code>External (_SB_.PCI0.GP13, DeviceObj)</code> -&gt; <code>External (_SB_.PC00.RP05, DeviceObj)</code></li>
<li><code>External (_SB_.PCI0.GP13.XHC0, DeviceObj)</code> -&gt; <code>External (_SB_.PC00.RP05.PXSX, DeviceObj)</code></li>
<li><code>Scope (\_SB.PCI0.GP13)</code> -&gt; <code>Scope (\_SB.PC00.RP05)</code></li>
<li><code>Scope (XHC0)</code> -&gt; <code>Scope (PXSX)</code></li>
</ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="../intel-mapping/intel.html" class="navigation navigation-prev " aria-label="Previous page: Intel USB Mapping">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../misc/" class="navigation navigation-next " aria-label="Next page: Miscellaneous Fixes">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"AMD and 3rd Party USB Mapping","level":"3.1","depth":1,"next":{"title":"Miscellaneous Fixes","level":"4.1","depth":1,"path":"misc/README.md","ref":"misc/README.md","articles":[{"title":"Fixing USB Power","level":"4.1.1","depth":2,"path":"misc/power.md","ref":"misc/power.md","articles":[]},{"title":"Fixing Shutdown/Restart","level":"4.1.2","depth":2,"path":"misc/shutdown.md","ref":"misc/shutdown.md","articles":[]},{"title":"GPRW/UPRW/LANC Instant Wake Patch","level":"4.1.3","depth":2,"path":"misc/instant-wake.md","ref":"misc/instant-wake.md","articles":[]},{"title":"Keyboard Wake Issues","level":"4.1.4","depth":2,"path":"misc/keyboard.md","ref":"misc/keyboard.md","articles":[]}]},"previous":{"title":"Intel USB Mapping","level":"2.1","depth":1,"path":"intel-mapping/intel.md","ref":"intel-mapping/intel.md","articles":[]},"dir":"ltr"},"config":{"plugins":["theme-default","-lunr","-search","search-plus","addcssjs","favicon-plus","anchors","github-buttons","last-modified","medium-zoom"],"styles":{"ebook":"styles/ebook.css","epub":"styles/epub.css","mobi":"styles/mobi.css","pdf":"styles/pdf.css","print":"styles/print.css","website":"styles/website.css"},"pluginsConfig":{"last-modified":{},"output":"_book","intopic-toc":{"label":"Navigation"},"addcssjs":{"css":[],"js":[]},"medium-zoom":{},"fontsettings":{"theme":"night","family":"sans","size":2},"favicon-plus":{"appleTouchIconPrecomposed152":"","favicon":"","output":"_book"},"highlight":{},"github-edit":{"repo":"dortania/USB-Map-Guide","branch":"master"},"favicon":"/icons/favicon.ico","appleTouchIconPrecomposed152":"/icons/appleTouchIconPrecomposed152.png","github-buttons":{"buttons":[{"user":"dortania","repo":"USB-Map-Guide","type":"star","size":"large"}]},"sharing":{"facebook":false,"twitter":false,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":[]},"theme-default":{"showLevel":false,"styles":{"ebook":"styles/ebook.css","epub":"styles/epub.css","mobi":"styles/mobi.css","pdf":"styles/pdf.css","print":"styles/print.css","website":"styles/website.css"}},"anchors":{},"search-plus":{}},"theme":"default","medium-zoom":{"margin":24,"background":"#363b40","scrollOffset":0},"pdf":{"pageBreaksBefore":"/","headerTemplate":null,"paperSize":"a4","margin":{"right":62,"left":62,"top":36,"bottom":36},"fontSize":12,"fontFamily":"Arial","footerTemplate":null,"chapterMark":"pagebreak","pageNumbers":false},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"links":{"sharing":{"google":false,"facebook":false,"twitter":false,"weibo":false,"all":false}},"gitbook":"*"},"file":{"path":"amd-mapping/amd.md","mtime":"2020-06-20T16:54:40.152Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2020-06-20T16:55:36.612Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search-plus/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github-buttons/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-medium-zoom/medium-zoom.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-medium-zoom/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    

    </body>
</html>

